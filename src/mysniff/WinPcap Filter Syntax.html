<head>
  <!-- <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"> -->
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>WinPcap: Filtering expression syntax</title>
  <link href="style.css" rel="stylesheet" type="text/css">
</head>

<body>
  <!-- Generated by Doxygen 1.3.7 -->
  <!-- <div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex"
      href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a
      class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a>
    | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>
  </div> -->
  <h1 align="center">Filtering expression syntax<br>
    <small>
      [过滤规则语法手册]</small>
  </h1>
  <table border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td></td>
      </tr>
    </tbody>
  </table>



  <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
  <meta name="GENERATOR" content="Microsoft FrontPage 4.0">
  <meta name="ProgId" content="FrontPage.Editor.Document">
  <title></title>



  <dl compact="">
    <dt>Note: this document has been drawn from the tcpdump man page. The original version can
      be found at&nbsp; <a href="http://www.tcpdump.org">www.tcpdump.org</a>.
    </dt>
    <dd>&nbsp;</dd>
    <dt>wpcap filters are based on a declarative predicate syntax. A filter is
      an ASCII string containing a filtering <i>expression</i>.&nbsp;pcap_compile()
      takes the expression and translates it in a program for the kernel-level
      packet filter.
    </dt>
  </dl>
  <p>The expression selects which packets will be dumped.
    If no expression
    is given, all packets on the net will be accepted by the kernel-level filtering
    engine.
    Otherwise,
    only packets for which <i>expression</i> is `true' will be accepted.</p>
  <p>

    The <i>expression</i> consists of one or more
    <i>primitives.</i>

    Primitives usually consist of an
    <i>id</i>

    (name or number) preceded by one or more qualifiers.
    There are three
    different kinds of qualifier:
  </p>
  <dl compact="">
    <dt><i>type</i></dt>
    <dd>
      qualifiers say what kind of thing the id name or number refers to.
      Possible types are
      <b>host</b>,

      <b>net</b>

      and
      <b>port</b>.

      E.g., `host foo', `net 128.3', `port 20'.
      If there is no type
      qualifier,
      <b>host</b>

      is assumed.
    </dd>
    <dt><i>dir</i></dt>
    <dd>
      qualifiers specify a particular transfer direction to and/or from
      <i>id</i>.

      Possible directions are
      <b>src</b>,

      <b>dst</b>,

      <b>src or dst</b>

      and
      <b>src and</b>

      <b>dst</b>.

      E.g., `src foo', `dst net 128.3', `src or dst port ftp-data'.
      If
      there is no dir qualifier,
      <b>src or dst</b>

      is assumed.
      For `null' link layers (i.e. point to point protocols such as slip) the
      <b>inbound</b>

      and
      <b>outbound</b>

      qualifiers can be used to specify a desired direction.
    </dd>
    <dt><i>proto</i></dt>
    <dd>
      qualifiers restrict the match to a particular protocol.
      Possible
      protos are:
      <b>ether</b>,

      <b>fddi</b>,

      <b>tr</b>,

      <b>ip</b>,

      <b>ip6</b>,

      <b>arp</b>,

      <b>rarp</b>,

      <b>decnet</b>,

      <b>tcp</b>

      and
      <b>udp</b>.

      E.g., `ether src foo', `arp net 128.3', `tcp port 21'.
      If there is
      no proto qualifier, all protocols consistent with the type are
      assumed.
      E.g., `src foo' means `(ip or arp or rarp) src foo'
      (except the latter is not legal syntax), `net bar' means `(ip or
      arp or rarp) net bar' and `port 53' means `(tcp or udp) port 53'.
    </dd>
  </dl>
  <p>

    [`fddi' is actually an alias for `ether'; the parser treats them
    identically as meaning ``the data link level used on the specified
    network interface.'' FDDI headers contain Ethernet-like source
    and destination addresses, and often contain Ethernet-like packet
    types, so you can filter on these FDDI fields just as with the
    analogous Ethernet fields.
    FDDI headers also contain other fields,
    but you cannot name them explicitly in a filter expression.
  </p>
  <p>

    Similarly, `tr' is an alias for `ether'; the previous paragraph's
    statements about FDDI headers also apply to Token Ring headers.]
  </p>
  <p>

    In addition to the above, there are some special `primitive' keywords
    that don't follow the pattern:
    <b>gateway</b>,

    <b>broadcast</b>,

    <b>less</b>,

    <b>greater</b>

    and arithmetic expressions.
    All of these are described below.
  </p>
  <p>

    More complex filter expressions are built up by using the words
    <b>and</b>,

    <b>or</b>

    and
    <b>not</b>

    to combine primitives.
    E.g., `host foo and not port ftp and not port ftp-data'.
    To save typing, identical qualifier lists can be omitted.
    E.g.,
    `tcp dst port ftp or ftp-data or domain' is exactly the same as
    `tcp dst port ftp or tcp dst port ftp-data or tcp dst port domain'.
  </p>
  <p>

    Allowable primitives are:
  </p>
  <dl compact="">
    <dt><b>dst host </b><i>host</i></dt>
    <dd>
      True if the IPv4/v6 destination field of the packet is <i>host</i>,
      which may be either an address or a name.
    </dd>
    <dt><b>src host </b><i>host</i></dt>
    <dd>
      True if the IPv4/v6 source field of the packet is <i>host</i>.
    </dd>
    <dt><b>host </b><i>host</i></dt>
    <dd>
      True if either the IPv4/v6 source or destination of the packet is <i>host</i>.
      Any of the above host expressions can be prepended with the keywords,
      <b>ip</b>, <b>arp</b>, <b>rarp</b>, or <b>ip6</b> as in:
      <dl compact="">
        <dd>

          <pre><b>ip host </b><i>host</i></pre>


        </dd>
      </dl>


      which is equivalent to:
      <dl compact="">
        <dd>

          <pre><b>ether proto </b><i>\ip</i><b> and host </b><i>host</i></pre>


        </dd>
      </dl>


      If <i>host</i> is a name with multiple IP addresses, each address will
      be checked for a match.
    </dd>
    <dt><b>ether dst </b><i>ehost</i></dt>
    <dd>
      True if the ethernet destination address is <i>ehost</i>.
      <i>Ehost</i>
      may be either a name from /etc/ethers or a number (see
      <i>ethers</i>(3N)

      for numeric format).
    </dd>
    <dt><b>ether src </b><i>ehost</i></dt>
    <dd>
      True if the ethernet source address is <i>ehost</i>.
    </dd>
    <dt><b>ether host </b><i>ehost</i></dt>
    <dd>
      True if either the ethernet source or destination address is <i>ehost</i>.
    </dd>
    <dt><b>gateway</b> <i>host</i></dt>
    <dd>
      True if the packet used <i>host</i> as a gateway.
      I.e., the ethernet
      source or destination address was <i>host</i> but neither the IP source
      nor the IP destination was <i>host</i>.
      <i>Host</i> must be a name and
      must be found both by the machine's host-name-to-IP-address resolution
      mechanisms (host name file, DNS, NIS, etc.) and by the machine's
      host-name-to-Ethernet-address resolution mechanism (/etc/ethers, etc.).
      (An equivalent expression is
      <dl compact="">
        <dd>

          <pre><b>ether host </b><i>ehost </i><b>and not host </b><i>host</i></pre>


        </dd>
      </dl>


      which can be used with either names or numbers for <i>host / ehost</i>.)
      This syntax does not work in IPv6-enabled configuration at this moment.
    </dd>
    <dt><b>dst net </b><i>net</i></dt>
    <dd>
      True if the IPv4/v6 destination address of the packet has a network
      number of <i>net</i>.
      <i>Net</i> may be either a name from /etc/networks
      or a network number (see <i>networks(4)</i> for details).
    </dd>
    <dt><b>src net </b><i>net</i></dt>
    <dd>
      True if the IPv4/v6 source address of the packet has a network
      number of <i>net</i>.
    </dd>
    <dt><b>net </b><i>net</i></dt>
    <dd>
      True if either the IPv4/v6 source or destination address of the packet has a network
      number of <i>net</i>.
    </dd>
    <dt><b>net </b><i>net</i> <b>mask </b><i>netmask</i></dt>
    <dd>
      True if the IP address matches <i>net</i> with the specific <i>netmask</i>.
      May be qualified with <b>src</b> or <b>dst</b>.
      Note that this syntax is not valid for IPv6 <i>net</i>.
    </dd>
    <dt><b>net </b><i>net</i>/<i>len</i></dt>
    <dd>
      True if the IPv4/v6 address matches <i>net</i> with a netmask <i>len</i>
      bits wide.
      May be qualified with <b>src</b> or <b>dst</b>.
    </dd>
    <dt><b>dst port </b><i>port</i></dt>
    <dd>
      True if the packet is ip/tcp, ip/udp, ip6/tcp or ip6/udp and has a
      destination port value of <i>port</i>.
      The <i>port</i> can be a number or a name used in /etc/services (see
      <i>tcp</i>(4P)

      and
      <i>udp</i>(4P)).

      If a name is used, both the port
      number and protocol are checked.
      If a number or ambiguous name is used,
      only the port number is checked (e.g., <b>dst port 513</b> will print both
      tcp/login traffic and udp/who traffic, and <b>port domain</b> will print
      both tcp/domain and udp/domain traffic).
    </dd>
    <dt><b>src port </b><i>port</i></dt>
    <dd>
      True if the packet has a source port value of <i>port</i>.
    </dd>
    <dt><b>port </b><i>port</i></dt>
    <dd>
      True if either the source or destination port of the packet is <i>port</i>.
      Any of the above port expressions can be prepended with the keywords,
      <b>tcp</b> or <b>udp</b>, as in:
      <dl compact="">
        <dd>

          <pre><b>tcp src port </b><i>port</i></pre>


        </dd>
      </dl>


      which matches only tcp packets whose source port is <i>port</i>.
    </dd>
    <dt><b>less </b><i>length</i></dt>
    <dd>
      True if the packet has a length less than or equal to <i>length</i>.
      This is equivalent to:
      <dl compact="">
        <dd>

          <pre><b>len &lt;= </b><i>length</i>.</pre>


        </dd>
      </dl>


    </dd>
    <dt><b>greater </b><i>length</i></dt>
    <dd>
      True if the packet has a length greater than or equal to <i>length</i>.
      This is equivalent to:
      <dl compact="">
        <dd>

          <pre><b>len &gt;= </b><i>length</i>.</pre>


        </dd>
      </dl>


    </dd>
    <dt><b>ip proto </b><i>protocol</i></dt>
    <dd>
      True if the packet is an IP packet (see
      <i>ip</i>(4P))

      of protocol type <i>protocol</i>.
      <i>Protocol</i> can be a number or one of the names
      <i>icmp</i>, <i>icmp6</i>, <i>igmp</i>, <i>igrp</i>, <i>pim</i>, <i>ah</i>,
      <i>esp</i>, <i>vrrp</i>, <i>udp</i>, or <i>tcp</i>.
      Note that the identifiers <i>tcp</i>, <i>udp</i>, and <i>icmp</i> are also
      keywords and must be escaped via backslash (\), which is \\ in the C-shell.
      Note that this primitive does not chase the protocol header chain.
    </dd>
    <dt><b>ip6 proto </b><i>protocol</i></dt>
    <dd>
      True if the packet is an IPv6 packet of protocol type <i>protocol</i>.
      Note that this primitive does not chase the protocol header chain.
    </dd>
    <dt><b>ip6 protochain </b><i>protocol</i></dt>
    <dd>
      True if the packet is IPv6 packet,
      and contains protocol header with type <i>protocol</i>
      in its protocol header chain.
      For example,
      <dl compact="">
        <dd>

          <pre><b>ip6 protochain 6</b></pre>


        </dd>
      </dl>


      matches any IPv6 packet with TCP protocol header in the protocol header chain.
      The packet may contain, for example,
      authentication header, routing header, or hop-by-hop option header,
      between IPv6 header and TCP header.
      The BPF code emitted by this primitive is complex and
      cannot be optimized by BPF optimizer code in <i>tcpdump</i>,
      so this can be somewhat slow.
    </dd>
    <dt><b>ip protochain </b><i>protocol</i></dt>
    <dd>
      Equivalent to <b>ip6 protochain </b><i>protocol</i>, but this is for IPv4.
    </dd>
    <dt><b>ether broadcast</b></dt>
    <dd>
      True if the packet is an ethernet broadcast packet.
      The <i>ether</i>
      keyword is optional.
    </dd>
    <dt><b>ip broadcast</b></dt>
    <dd>
      True if the packet is an IP broadcast packet.
      It checks for both
      the all-zeroes and all-ones broadcast conventions, and looks up
      the local subnet mask.
    </dd>
    <dt><b>ether multicast</b></dt>
    <dd>
      True if the packet is an ethernet multicast packet.
      The <i>ether</i>
      keyword is optional.
      This is shorthand for `<b>ether[0] &amp; 1 != 0</b>'.
    </dd>
    <dt><b>ip multicast</b></dt>
    <dd>
      True if the packet is an IP multicast packet.
    </dd>
    <dt><b>ip6 multicast</b></dt>
    <dd>
      True if the packet is an IPv6 multicast packet.
    </dd>
    <dt><b>ether proto </b><i>protocol</i></dt>
    <dd>
      True if the packet is of ether type <i>protocol</i>.
      <i>Protocol</i> can be a number or one of the names
      <i>ip</i>, <i>ip6</i>, <i>arp</i>, <i>rarp</i>, <i>atalk</i>, <i>aarp</i>,
      <i>decnet</i>, <i>sca</i>, <i>lat</i>, <i>mopdl</i>, <i>moprc</i>,
      <i>iso</i>, <i>stp</i>, <i>ipx</i>, or <i>netbeui</i>.
      Note these identifiers are also keywords
      and must be escaped via backslash (\).
    </dd>
    <dt></dt>
    <dd>
      [In the case of FDDI (e.g., `<b>fddi protocol arp</b>') and Token Ring
      (e.g., `<b>tr protocol arp</b>'), for most of those protocols, the
      protocol identification comes from the 802.2 Logical Link Control (LLC)
      header, which is usually layered on top of the FDDI or Token Ring
      header.
    </dd>
    <dt></dt>
    <dd>
      When filtering for most protocol identifiers on FDDI or Token Ring,
      <i>tcpdump</i> checks only the protocol ID field of an LLC header in
      so-called SNAP format with an Organizational Unit Identifier (OUI) of
      0x000000, for encapsulated Ethernet; it doesn't check whether the packet
      is in SNAP format with an OUI of 0x000000.
    </dd>
    <dt></dt>
    <dd>
      The exceptions are <i>iso</i>, for which it checks the DSAP (Destination
      Service Access Point) and SSAP (Source Service Access Point) fields of
      the LLC header, <i>stp</i> and <i>netbeui</i>, where it checks the DSAP of
      the LLC header, and <i>atalk</i>, where it checks for a SNAP-format
      packet with an OUI of 0x080007 and the Appletalk etype.
    </dd>
    <dt></dt>
    <dd>
      In the case of Ethernet, <i>tcpdump</i> checks the Ethernet type field
      for most of those protocols; the exceptions are <i>iso</i>, <i>sap</i>,
      and <i>netbeui</i>, for which it checks for an 802.3 frame and then
      checks the LLC header as it does for FDDI and Token Ring, <i>atalk</i>,
      where it checks both for the Appletalk etype in an Ethernet frame and
      for a SNAP-format packet as it does for FDDI and Token Ring, <i>aarp</i>,
      where it checks for the Appletalk ARP etype in either an Ethernet frame
      or an 802.2 SNAP frame with an OUI of 0x000000, and <i>ipx</i>, where it
      checks for the IPX etype in an Ethernet frame, the IPX DSAP in the LLC
      header, the 802.3 with no LLC header encapsulation of IPX, and the IPX
      etype in a SNAP frame.]
    </dd>
    <dt><b>decnet src </b><i>host</i></dt>
    <dd>
      True if the DECNET source address is
      <i>host</i>,

      which may be an address of the form ``10.123'', or a DECNET host
      name.
      [DECNET host name support is only available on Ultrix systems
      that are configured to run DECNET.]
    </dd>
    <dt><b>decnet dst </b><i>host</i></dt>
    <dd>
      True if the DECNET destination address is
      <i>host</i>.

    </dd>
    <dt><b>decnet host </b><i>host</i></dt>
    <dd>
      True if either the DECNET source or destination address is
      <i>host</i>.

    </dd>
    <dt><b>ip</b>, <b>ip6</b>, <b>arp</b>, <b>rarp</b>, <b>atalk</b>, <b>aarp</b>, <b>decnet</b>, <b>iso</b>,
      <b>stp</b>, <b>ipx</b>, <i>netbeui</i>
    </dt>
    <dd>
      Abbreviations for:
      <dl compact="">
        <dd>

          <pre><b>ether proto </b><i>p</i></pre>


        </dd>
      </dl>


      where <i>p</i> is one of the above protocols.
    </dd>
    <dt><b>lat</b>, <b>moprc</b>, <b>mopdl</b></dt>
    <dd>
      Abbreviations for:
      <dl compact="">
        <dd>

          <pre><b>ether proto </b><i>p</i></pre>


        </dd>
      </dl>


      where <i>p</i> is one of the above protocols.
      Note that
      <i>tcpdump</i> does not currently know how to parse these protocols.
    </dd>
    <dt><b>vlan </b><i>[vlan_id]</i></dt>
    <dd>
      True if the packet is an IEEE 802.1Q VLAN packet.
      If <i>[vlan_id]</i> is specified, only true is the packet has the specified
      <i>vlan_id</i>.
      Note that the first <b>vlan</b> keyword encountered in <i>expression</i>
      changes the decoding offsets for the remainder of <i>expression</i>
      on the assumption that the packet is a VLAN packet.
    </dd>
    <dt><b>tcp</b>, <b>udp</b>, <b>icmp</b></dt>
    <dd>
      Abbreviations for:
      <dl compact="">
        <dd>

          <pre><b>ip proto </b><i>p</i><b> or ip6 proto </b><i>p</i></pre>


        </dd>
      </dl>


      where <i>p</i> is one of the above protocols.
    </dd>
    <dt><b>iso proto </b><i>protocol</i></dt>
    <dd>
      True if the packet is an OSI packet of protocol type <i>protocol</i>.
      <i>Protocol</i> can be a number or one of the names
      <i>clnp</i>, <i>esis</i>, or <i>isis</i>.
    </dd>
    <dt><b>clnp</b>, <b>esis</b>, <b>isis</b></dt>
    <dd>
      Abbreviations for:
      <dl compact="">
        <dd>

          <pre><b>iso proto </b><i>p</i></pre>


        </dd>
      </dl>


      where <i>p</i> is one of the above protocols.
      Note that <i>tcpdump</i> does an incomplete job of parsing these protocols.
    </dd>
    <dt><i>expr relop expr</i></dt>
    <dd>
      True if the relation holds, where <i>relop</i> is one of &gt;, &lt;, &gt;=, &lt;=, =, !=,
      and <i>expr</i> is an arithmetic expression composed of integer constants
      (expressed in standard C syntax), the normal binary operators
      [+, -, *, /, &amp;, |], a length operator, and special packet data accessors.
      To access
      data inside the packet, use the following syntax:

      <pre><i>proto</i><b> [ </b><i>expr</i><b> : </b><i>size</i><b> ]</b>
</pre>


      <i>Proto</i> is one of <b>ether, fddi, tr,
        ip, arp, rarp, tcp, udp, icmp</b> or <b>ip6</b>, and
      indicates the protocol layer for the index operation.
      Note that <i>tcp, udp</i> and other upper-layer protocol types only
      apply to IPv4, not IPv6 (this will be fixed in the future).
      The byte offset, relative to the indicated protocol layer, is
      given by <i>expr</i>.
      <i>Size</i> is optional and indicates the number of bytes in the
      field of interest; it can be either one, two, or four, and defaults to one.
      The length operator, indicated by the keyword <b>len</b>, gives the
      length of the packet.
      <p>
        For example, `<b>ether[0] &amp; 1 != 0</b>' catches all multicast traffic.
        The expression `<b>ip[0] &amp; 0xf != 5</b>'
        catches all IP packets with options.
        The expression
        `<b>ip[6:2] &amp; 0x1fff = 0</b>'
        catches only unfragmented datagrams and frag zero of fragmented datagrams.
        This check is implicitly applied to the <b>tcp</b> and <b>udp</b>
        index operations.
        For instance, <b>tcp[0]</b> always means the first
        byte of the TCP <i>header</i>, and never means the first byte of an
        intervening fragment.
      </p>
      <p>
        Some offsets and field values may be expressed as names rather than
        as numeric values.
        The following protocol header field offsets are
        available: <b>icmptype</b> (ICMP type field), <b>icmpcode</b> (ICMP
        code field), and <b>tcpflags</b> (TCP flags field).
      </p>
      <p>
        The following ICMP type field values are available: <b>icmp-echoreply</b>,
        <b>icmp-unreach</b>, <b>icmp-sourcequench</b>, <b>icmp-redirect</b>,
        <b>icmp-echo</b>, <b>icmp-routeradvert</b>, <b>icmp-routersolicit</b>,
        <b>icmp-timxceed</b>, <b>icmp-paramprob</b>, <b>icmp-tstamp</b>,
        <b>icmp-tstampreply</b>, <b>icmp-ireq</b>, <b>icmp-ireqreply</b>,
        <b>icmp-maskreq</b>, <b>icmp-maskreply</b>.
      </p>
      <p>
        The following TCP flags field values are available: <b>tcp-fin</b>,
        <b>tcp-syn</b>, <b>tcp-rst</b>, <b>tcp-push</b>, <b>tcp-push</b>,
        <b>tcp-ack</b>, <b>tcp-urg</b>.
      </p>
    </dd>
  </dl>
  <p>

    Primitives may be combined using:
  </p>
  <dl compact="">
    <dt></dt>
    <dd>
      A parenthesized group of primitives and operators
      (parentheses are special to the Shell and must be escaped).
    </dd>
    <dt></dt>
    <dd>
      Negation (`<b>!</b>' or `<b>not</b>').
    </dd>
    <dt></dt>
    <dd>
      Concatenation (`<b>&amp;&amp;</b>' or `<b>and</b>').
    </dd>
    <dt></dt>
    <dd>
      Alternation (`<b>||</b>' or `<b>or</b>').
    </dd>
  </dl>
  <p>

    Negation has highest precedence.
    Alternation and concatenation have equal precedence and associate
    left to right.
    Note that explicit <b>and</b> tokens, not juxtaposition,
    are now required for concatenation.
  </p>
  <p>

    If an identifier is given without a keyword, the most recent keyword
    is assumed.
    For example,

  </p>
  <blockquote>

    <pre><b>not host vs and ace</b></pre>


  </blockquote>


  is short for
  <blockquote>

    <pre><b>not host vs and host ace</b></pre>


  </blockquote>


  which should not be confused with
  <blockquote>

    <pre><b>not ( host vs or ace )</b></pre>


  </blockquote>


  <p>

    Expression arguments can be passed to <i>tcpdump</i> as either a single
    argument or as multiple arguments, whichever is more convenient.
    Generally, if the expression contains Shell metacharacters, it is
    easier to pass it as a single, quoted argument.
    Multiple arguments are concatenated with spaces before being parsed.
  </p>
  <p>


  </p>
  <hr>
  <p align="left">
    本文档摘自WinPcap官方文档，并由 陈朗@NWPU整理</p>
</body>